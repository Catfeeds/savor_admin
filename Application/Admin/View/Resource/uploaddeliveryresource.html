<div class="pageContent">
	<div id="dz-filecontainer">
		<ul style="margin-bottom:10px;" class="nav nav-tabs">
			<li class="active" style="">
				<a href="#dropbase" data-toggle="tab"><span>上传广告</span></a>
			</li>
			<li class="pull-right">
				<a data-dismiss="modal" href="#">&times;</a>
			</li>
		</ul>
		<div class="tab-content">
			<div id="dropbase" class="tab-pane fade active in pageContent">
				<input id="autofill" type="hidden" value="{$autofill}">
				<input id="hidden_filed" type="hidden" value="{$hidden_filed}">
				<input id="up_resourcetype" type="hidden" value="{$rtype}">
				<input id="oss_host" type="hidden" value="{$oss_host}">
				<form id="dropbase-formdevilery" method="post" name=theform action="{$host_name}/resource/uploadAdvdeliveryResource" class="pageForm required-validate" enctype="multipart/form-data" onsubmit="return iframeCallback(this, dialogAjaxDone)">
					<input id="oss_id" type="hidden" name="id" value="{$row.id}">
					<input type="hidden" name="oss_addr" id='oss_addr' value=''>
					<input type="hidden" name="oss_filesize" id='oss_filesize' value=''>
					<div class="pageFormContent modal-body" style="margin-bottom: 14px;">
						<div class="form-group row">
							<div class="col-xs-12 col-sm-12">
								<div id="ossfile">你的浏览器不支持flash,Silverlight或者HTML5！</div>
							</div>
						</div>

						<div class="form-group row">
							<label class="col-xs-12 col-sm-2 control-label">
    			    视频内容
		        	</label>
							<div class="col-xs-12 col-sm-10">
								<a id="selectfiles" class="btn btn-success" href="javascript:void(0);"><i class="fa fa-plus"></i> 选择视频</a>
								<a id="postfiles" class="btn btn-success" href="javascript:void(0);"><i class="fa fa-upload"></i> 开始上传</a>
							</div>
						</div>
						<div class="form-group row">
							<label class="col-xs-12 col-sm-2 control-label" style="width: 66px;">
			          URL:
			        </label>
							<div class="col-xs-12 col-sm-10" style="margin-left: 26px;">
								<input type="text" class="form-control" id="media_url" value="" readonly>
							</div>
						</div>

						<div class="form-group row">
							<div class="form-inline">

								<div class="form-group col-md-6 col-xs-6 col-sm-6" style="width: 67px;">
									<label class=" control-label col-xs-12 col-sm-2" style="width: 100%;">
                      时长：
                    </label>

								</div>

								<div class="form-group col-md-4 col-xs-4 col-sm-4" style="width: 245px;margin-left: 26px;">

									<span class="form-control col-sm-2">秒</span><input style="width:60px;" min="1" max="3600" required alt="数字" id="seco" name="seco" type="text" value="<if condition=" $vainfo.duration gt 0 ">{$vainfo['duration']%60}<else/></if>" class="form-control col-sm-2" />
								</div>
							</div>
						</div>
						<div class="form-group row">
							<label class="col-xs-12 col-sm-2 control-label">
			          资源名称:
			        </label>
							<div class="col-xs-12 col-sm-10">
								<input type="text" class="form-control" id="resource_name" name="name" minlength="1" maxlength="40" value="{$vinfo.name}" required>
							</div>
						</div>
					</div>
					<div class="modal-footer">
						<button id="cancel_upload" class="btn btn-default close-m" type="button">取消</button>
						<button id="saveImg" class="btn btn-primary" type="button">保存</button>
					</div>
				</form>
			</div>
			<!--  -->
		</div>
	</div>
</div>
<script>
	var imgs = "Image files";
	var files = "files";
	var imgExt = "{$file_allexts.img_ext}";
	var fileExt = "{$file_allexts.file_ext}";
</script>
<script src='__PUBLIC__/admin/assets/js/oss/uploaddevilery.js'></script>
<script>
	/*==============================mark by s++================================*/

	var hiddenType = $("#hidden_filed").val();
	var hiddenImg = hiddenType + 'img';
	var resourceType = "";
	$(".resource_type").click(function() {
		resourceType = $(this).val();
	});
	console.log(resourceType);
	//选择本地图片点击保存 
	$("#saveImg").click(function() {
		var url = $("#media_url").val();
		var cot = $("#ossfile .progress-bar").attr('aria-valuenow');

		if(url == '') {
			if(cot != '100' && cot > 0) {
				alert('资源正在上传，请稍后');
				return false;
			} else {
				alert('请上传资源');
				return false;
			}
		}
		
		$.ajax({
			url: $("#dropbase-formdevilery").attr("action"),
			type: "post",
			dataType: "json",
			data: {
				"id": $("#oss_id").val(),
				"oss_addr": $("#oss_addr").val(),
				"oss_filesize": $("#oss_filesize").val(),
				"name": $("#resource_name").val(),
				"type": resourceType,
				"seco": $("#seco").val(),
				"description": $("#description").val(),
			},
			success: function(result) {
				//covervideo_id  covervideo_idimg media_id media_idimg
				console.log(result);
				// alert($("#resource_name").val());
				// $("#media_idimgname").val($("#resource_name").val());
				//  $("#media_idimgname").html($("#resource_name").val());
				//console.log($("#resource_type").val());

				if(result.code == 10000) {

					$("#" + hiddenType).val(result.data.media_id);
					$("#" + hiddenImg).attr("src", result.data.path).show();
					if(hiddenType == 'ueditor') {
						var ueIn = UE.getEditor("editor");
						ueIn.execCommand('insertimage', {
							src: result.data.path
						});
					} else {
						if(hiddenType == 'media_id' && hiddenImg == 'media_idimg') {
							$("#xuanpian #media_idimg").attr("src", $("#covervideo_idimg").attr("src"));
							$("#xuanpian #xuanpianhr").attr("href", result.data.path);
							$("#media_idimgname").val($("#resource_name").val());
							$("#media_idimgname").html($("#resource_name").val());
						}

					}
					if($('#seco').val()>=3600||$('#seco').val()<=0){
						alert('请输入大于1小于3600的值');
						return false;
					}
                    $("#marketid").val(result.data.media_id);
					$("#dz-filecontainer .nav-tabs .pull-right a").click();
				} else {
					// $("#dz-filecontainer .nav-tabs .pull-right a").click();
					alert(result.msg);
					return false;
				}
			},
			error: function() {
				$("#dz-filecontainer .nav-tabs .pull-right a").click();
			}
		})
		var media_url = $('#media_url').val();  //视频地址
	var resource_name = $('#resource_name').val();  //视频名称
	var seco = $('#seco').val();  //视频时长
	$('#sp_name').html(resource_name);
	$('#sp_url').html(media_url);
	if(seco<60){
		
		$('#sp_time').html(seco+'秒')
	}else if(seco>=60){
		var fen = parseInt(seco/60);
		var miaos = seco-60*fen;
		if(miaos==0){
			$('#sp_time').html(fen+'分钟00秒');
		}else{
			$('#sp_time').html(fen+'分钟'+miaos+'秒');
		}
	}
	$('#newsp').show()
	$('#sp').hide();
	})

	//查找数据
	$("#searchmedia").click(function() {
		$.ajax({
			url: "{$host_name}/resource/searchResource",
			type: "post",
			dataType: "html",
			data: {
				"filed": $("#hidden_filed").val(),
				"rtype": $("#up_resourcetype").val(),
				"autofill": $("#autofill").val(),
				"name": $("#titlename").val(),
			},
			success: function(result) {
				$("#file-list").html('');
				$("#file-list").html(result);
			},
			error: function() {

				$("#dz-filecontainer .nav-tabs .pull-right a").click();
			}
		})
	})

	$("#cancel_upload").click(function() {
		$("#dz-filecontainer .nav-tabs .pull-right a").click();
	})
	//领取图片数据
	function getImageInfo($this) {
		$('#files').find('.file-content').removeClass("active");
		var $file = $this.closest('.file-content');
		$file.addClass("active");
		var $ck = $('#files input:checked')
		var count = $ck.length;
		var autofill = $("#autofill").val();
		if(count == 1) {
			//alert($ck.val());
			//alert($file.find(".dz-nthumb").attr("src"));
			$("#" + hiddenType).val($ck.val());
			$("#dz-filecontainer .nav-tabs .pull-right a").click();
			if($file.find(".dz-nthumb").size() > 0) {
				$("#" + hiddenImg).attr("src", $file.find(".dz-nthumb").attr("src")).show();
				$("#" + hiddenImg + "name").hide();
				if(hiddenType == 'ueditor') {
					var ueIn = UE.getEditor("editor");
					ueIn.execCommand('insertimage', {
						src: $file.find(".dz-nthumb").attr("src")
					});
				}
			} else {
				$("#" + hiddenImg).hide();
				if(autofill == 1) {
					var autofillname = $file.find(".dz-file").text();
					$("#" + hiddenImg + "name").val($.trim(autofillname));

					if(hiddenImg == 'media_idimg' && hiddenType == 'media_id') {
						var mphr = $file.attr("data-src");
						$file.addClass("active");
						$("#xuanpian #" + hiddenImg).show();
						$("#xuanpian #" + hiddenImg).attr("src", $("#covervideo_idimg").attr("src"));
						$("#xuanpian #xuanpianhr").attr("href", mphr);
					}
				} else {
					$("#" + hiddenImg + "name").text($file.find(".dz-file").text()).show();
				}
			}
		} else {
			alert("只能选择一张图片");
		}
	}
	//选择资料库文件
	var cntrlIsPressed = false;
	$(document).keydown(function(event) {
		if(event.which == "17" && mult != "") {
			cntrlIsPressed = true;
		} else {
			cntrlIsPressed = false;
		}
	});

	$(document).keyup(function() {
		cntrlIsPressed = false;
	});
	$(document).on("click", "#files input", function() {
		if(!cntrlIsPressed) {
			$('#files').find('input').prop("checked", false);
			$(this).prop("checked", true);
		}
		getImageInfo($(this));
	});
	var pageNum = 2;
	var rtype = $("#up_resourcetype").val();
	$("#files .dz-file-viewport").scroll(function() {
		//console.log("scroll")
		var t = $("#file-list").height();
		var c = $(this).height();
		var s = $(this).scrollTop();
		// var n = $("#files{$multiple} .loadpoint").data("next");
		// var l = $("#files{$multiple} .loadpoint").data("load");
		//console.log(s+"-"+(t-c))
		if((t - c) <= s) {
			$.ajax({
				url: "{$host_name}/resource/resourceList?isbrowse=1&pageNum=" + pageNum + "&rtype=" + rtype,
				type: "get",
				dataType: "json",
				success: function(result) {
					if(result.code == 10000 && result.data.length > 0) {
						var str = "";
						for(var i in result.data) {
							//console.log(result.data[i].surfix+"|||"+result.data[i].name);
							if(typeof(result.data[i]) == 'object') {
								str += '<div class="dz-preview dz-file-preview" data-list-file>' +
									'<div class="file-content" data-wh="" data-title="' + result.data[i].name + '" data-src="' + result.data[i].oss_addr + '">' +
									'<div class="dz-overlay hidden"></div>' +
									'<label class="dz-check">' +
									'<input type="checkbox" value="' + result.data[i].id + '" name="selected[]">' +
									'<span><i class="fa fa-check"></i></span>' +
									'</label>' +
									'<div class="dz-details" title="' + result.data[i].name + '">';
								if(result.data[i].surfix == "png" || result.data[i].surfix == "jpg" || result.data[i].surfix == "gif" || result.data[i].surfix == "jpeg") {
									str += '<img class="dz-nthumb" style="width:100%" src="' + result.data[i].oss_addr + '"/>';
									str += '<span style="width:100%;height:1.4em;line-height:1.4em;padding:0 10px;position:absolute;bottom:10px;overflow:hidden;text-overflow:ellipsis;background:rgba(255,255,255,0.5);">' + result.data[i].name + '</span>'
								} else {
									str += '<div class="dz-file">' +
										'<i class="file-' + result.data[i].surfix + '"></i>' +
										'<span>' + result.data[i].name + '</span>' +
										'</div>';
								}
								str += '</div>' +
									// '<div class="dz-info clearfix">'+
									//   '<div class="dz-size" data-dz-size data-size="'+result.data[i].shw_size+'"></div>'+
									//   '<a warn="警告" title="你确定要删除这文件吗？" target="ajaxTodo" href="{$host_name}/uploadmgr/uploadmgrDel?id='+result.data[i].id+'" calback="navTabAjaxDone" class="btn btn-danger btn-icon pull-right del-file"><span><i class="fa fa-trash"></i></span></a>'+
									// '</div>'+
									'</div>' +
									'</div>';
							} else {
								continue;
							}
						}
						$("#file-list").append(str);
						pageNum++;
					}
				},
				error: function() {
					console.log("error");
				}
			})
		}
	});
</script>